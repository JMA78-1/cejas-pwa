<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cejas por Pares (6) + Espejo</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#121a2a">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#0b0f19; --panel:#121a2a; --text:#e7eefc; --muted:#a7b6d6;
      --border:#22304e; --btn:#1c2a46; --btn2:#243457; --accent:#6ea8ff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #070a12, var(--bg));
      color:var(--text);
      min-height:100vh;
    }

    /* Layout responsive: en desktop 2 columnas, en móvil se apila */
    .wrap{
      display:grid;
      grid-template-columns: 380px 1fr;
      width:100%;
      min-height:100vh;
    }

    .panel{
      background: rgba(18,26,42,.85);
      border-right:1px solid var(--border);
      padding:16px 14px;
      backdrop-filter: blur(8px);
      overflow:auto;
      min-height:100vh;
    }

    h1{ font-size:16px; margin:0 0 10px 0; }
    p{ margin:8px 0 12px; color:var(--muted); font-size:13px; line-height:1.35; }

    .group{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin:10px 0;
      background: rgba(8,12,22,.55);
    }
    .group h2{ font-size:13px; margin:0 0 10px; color:#d7e5ff; font-weight:650; }
    .row{ display:flex; gap:10px; align-items:center; margin:8px 0; }
    label{ font-size:13px; color:var(--muted); min-width:150px; }
    select, input[type="range"], input[type="file"]{ width:100%; }
    select{
      background:#0b1324;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
    }
    input[type="range"]{ accent-color: var(--accent); }
    .btns{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    button{
      background:var(--btn);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      cursor:pointer;
      font-weight:600;
    }
    button:hover{ background:var(--btn2); }
    .hint{ font-size:12px; color:var(--muted); margin-top:10px; }

    /* ZONA CANVAS: responsive */
    .stage{
      width:100%;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      overflow:hidden;
    }

    canvas{
      width:100%;
      height:100%;
      max-width:100%;
      max-height:100%;
      background:#f8fbff;
      border-radius:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.18);
      touch-action:none;
      display:block;
    }

    .legend{ display:flex; gap:10px; align-items:center; margin-top:8px; font-size:12px; color:var(--muted); flex-wrap:wrap; }
    .swatch{ width:14px; height:14px; border-radius:4px; border:1px solid rgba(255,255,255,.25); display:inline-block; }
    .previews{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px; }
    .thumb{
      border:1px solid var(--border);
      border-radius:10px;
      background: rgba(255,255,255,.05);
      padding:6px;
      cursor:pointer;
    }
    .thumb.active{ outline:2px solid rgba(110,168,255,.9); border-color: rgba(110,168,255,.9); }
    .thumb canvas{ width:100%; height:auto; border-radius:8px; box-shadow:none; border:none; background:#fff; }
    .small{ font-size:12px; color:var(--muted); }

    /* MÓVIL: apila panel arriba y canvas abajo */
    @media (max-width: 900px){
      .wrap{
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .panel{
        min-height:auto;
        height: 46vh;
        border-right:none;
        border-bottom:1px solid var(--border);
      }
      .stage{
        height: 54vh;
      }
      label{ min-width: 130px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <aside class="panel">
    <h1>Cejas (6 pares) + espejo de trazo</h1>
    <p>Plantilla fija desde <b>Cejas.jpg</b> (ya viene en pares). El espejo se aplica a tus trazos.</p>

    <div class="group">
      <h2>Plantilla (Cejas.jpg)</h2>
      <div class="row">
        <label>Fuente</label>
        <select id="imgSource">
          <option value="default">Cejas.jpg (misma carpeta)</option>
          <option value="upload">Cargar archivo…</option>
        </select>
      </div>
      <div class="row" id="uploadRow" style="display:none;">
        <label>Archivo</label>
        <input id="fileInput" type="file" accept="image/*" />
      </div>

      <div class="row">
        <label>Par</label>
        <select id="pairSelect"></select>
      </div>

      <div class="small">Tip: clic en miniatura para elegir par.</div>
      <div class="previews" id="previews"></div>
    </div>

    <div class="group">
      <h2>Tipo de línea</h2>
      <div class="row">
        <label for="lineType">Seleccionar</label>
        <select id="lineType">
          <option value="spina">Línea Espina</option>
          <option value="primaria">Línea Primaria</option>
          <option value="secundaria">Línea Secundaria</option>
        </select>
      </div>
      <div class="row">
        <label for="size">Grosor</label>
        <input id="size" type="range" min="1" max="14" step="1" value="4"/>
      </div>
      <div class="row">
        <label for="stabilizer">Estabilizador</label>
        <input id="stabilizer" type="range" min="0" max="0.9" step="0.05" value="0.45"/>
      </div>
      <div class="legend" id="legend"></div>
      <div class="small">Sugerido: 0.55–0.80 (mouse), 0.25–0.50 (stylus).</div>
    </div>

    <div class="group">
      <h2>Ajustes</h2>
      <div class="row">
        <label for="templateScale">Escala plantilla</label>
        <input id="templateScale" type="range" min="50" max="170" step="1" value="115"/>
      </div>
      <div class="row">
        <label for="mirrorOffset">Offset eje espejo</label>
        <input id="mirrorOffset" type="range" min="-120" max="120" step="1" value="0"/>
      </div>
      <div class="row">
        <label for="showGuide">Guía eje</label>
        <select id="showGuide">
          <option value="yes">Sí</option>
          <option value="no">No</option>
        </select>
      </div>
      <div class="row">
        <label for="drawLimit">Limitar dibujo</label>
        <select id="drawLimit">
          <option value="yes">Sí (solo mitad izquierda)</option>
          <option value="no">No</option>
        </select>
      </div>
      <div class="small">Si el espejo “no cae” exactamente, ajusta Offset eje espejo.</div>
    </div>

    <div class="group">
      <h2>Acciones</h2>
      <div class="btns">
        <button id="undoBtn" title="Ctrl+Z">Deshacer</button>
        <button id="clearBtn">Limpiar trazos</button>
        <button id="saveBtn">Guardar PNG</button>
        <button id="resetViewBtn">Recentrar</button>
      </div>
      <div class="hint">Ctrl+Z también funciona.</div>
    </div>
  </aside>

  <main class="stage">
    <canvas id="c"></canvas>
  </main>
</div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  // UI
  const imgSource = document.getElementById('imgSource');
  const uploadRow = document.getElementById('uploadRow');
  const fileInput = document.getElementById('fileInput');
  const pairSelect = document.getElementById('pairSelect');
  const previews = document.getElementById('previews');

  const lineTypeSel = document.getElementById('lineType');
  const sizeRange = document.getElementById('size');
  const stabilizerRange = document.getElementById('stabilizer');

  const templateScale = document.getElementById('templateScale');
  const mirrorOffset = document.getElementById('mirrorOffset');
  const showGuideSel = document.getElementById('showGuide');
  const drawLimitSel = document.getElementById('drawLimit');

  const undoBtn = document.getElementById('undoBtn');
  const clearBtn = document.getElementById('clearBtn');
  const saveBtn = document.getElementById('saveBtn');
  const resetViewBtn = document.getElementById('resetViewBtn');
  const legend = document.getElementById('legend');

  // Colores
  const palette = {
    spina:    { name: "Línea Espina",     color: "#0b2a9b" },
    primaria: { name: "Línea Primaria",   color: "#2f66ff" },
    secundaria:{name:"Línea Secundaria",  color: "#89b5ff" }
  };

  function renderLegend(){
    legend.innerHTML = '';
    for (const k of ["spina","primaria","secundaria"]) {
      const span = document.createElement('span');
      span.style.display = 'inline-flex';
      span.style.alignItems = 'center';
      span.style.gap = '6px';
      const sw = document.createElement('i');
      sw.className = 'swatch';
      sw.style.background = palette[k].color;
      span.appendChild(sw);
      span.appendChild(document.createTextNode(palette[k].name));
      legend.appendChild(span);
    }
  }
  renderLegend();

  // View (en CSS px)
  const view = { cx: 0, cy: 0 };
  function resetView(){ view.cx = canvas.getBoundingClientRect().width/2; view.cy = canvas.getBoundingClientRect().height/2; }
  resetViewBtn.addEventListener('click', () => { resetView(); draw(); });

  // Responsive canvas (HiDPI)
  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const cssW = Math.max(1, rect.width);
    const cssH = Math.max(1, rect.height);
    const dpr = window.devicePixelRatio || 1;

    canvas.width = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);

    // Dibujar usando coordenadas en CSS px
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    // Recentra vista
    view.cx = cssW / 2;
    view.cy = cssH / 2;

    draw();
  }

  window.addEventListener('resize', resizeCanvas);
  window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 150));

  // Strokes
  let strokes = [];
  let drawing = false;
  let current = null;
  let lastSmoothed = null;

  // Template pairs
  const tpl = {
    img: null,
    rows: 6,
    selected: 0,
    pairCanvases: [],
    pairW: 0,
    pairH: 0
  };

  function getPointerPos(ev){
    const rect = canvas.getBoundingClientRect();
    return { x: ev.clientX - rect.left, y: ev.clientY - rect.top };
  }

  // Suavizado EMA
  function smoothPoint(prev, raw, s){
    if (!prev) return raw;
    const alpha = Math.max(0.05, 1 - s);
    return { x: prev.x + alpha*(raw.x-prev.x), y: prev.y + alpha*(raw.y-prev.y) };
  }

  function drawSmoothStroke(stroke){
    const pts = stroke.points;
    if (pts.length < 2) return;

    ctx.save();
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = palette[stroke.type].color;
    ctx.lineWidth = stroke.size;

    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for (let i=1; i<pts.length-1; i++){
      const mx = (pts[i].x + pts[i+1].x)/2;
      const my = (pts[i].y + pts[i+1].y)/2;
      ctx.quadraticCurveTo(pts[i].x, pts[i].y, mx, my);
    }
    ctx.lineTo(pts[pts.length-1].x, pts[pts.length-1].y);
    ctx.stroke();
    ctx.restore();
  }

  function rebuildPairs(){
    tpl.pairCanvases = [];
    if (!tpl.img) return;

    const srcW = tpl.img.width;
    const srcH = tpl.img.height;
    tpl.pairW = srcW;
    tpl.pairH = Math.floor(srcH / tpl.rows);

    const padY = 2;
    for (let r=0; r<tpl.rows; r++){
      const sy = Math.floor(r * tpl.pairH + padY);
      const sh = Math.floor(tpl.pairH - padY*2);

      const c = document.createElement('canvas');
      c.width = srcW;
      c.height = sh;
      const cctx = c.getContext('2d');
      cctx.drawImage(tpl.img, 0, sy, srcW, sh, 0, 0, srcW, sh);

      tpl.pairCanvases.push(c);
    }

    pairSelect.innerHTML = '';
    for (let i=0; i<tpl.rows; i++){
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = `Par ${i+1}`;
      pairSelect.appendChild(opt);
    }
    pairSelect.value = String(tpl.selected);

    buildPreviews();
  }

  function buildPreviews(){
    previews.innerHTML = '';
    for (let i=0; i<tpl.pairCanvases.length; i++){
      const wrap = document.createElement('div');
      wrap.className = 'thumb' + (i === tpl.selected ? ' active' : '');
      const t = document.createElement('canvas');
      t.width = 220; t.height = 110;
      const tctx = t.getContext('2d');
      tctx.fillStyle = "#fff";
      tctx.fillRect(0,0,t.width,t.height);

      const bmp = tpl.pairCanvases[i];
      const s = Math.min(t.width / bmp.width, t.height / bmp.height) * 0.96;
      const dw = bmp.width * s;
      const dh = bmp.height * s;
      tctx.drawImage(bmp, (t.width-dw)/2, (t.height-dh)/2, dw, dh);

      wrap.appendChild(t);
      wrap.addEventListener('click', () => {
        tpl.selected = i;
        pairSelect.value = String(i);
        setActiveThumb();
        draw();
      });
      previews.appendChild(wrap);
    }
    setActiveThumb();
  }

  function setActiveThumb(){
    [...previews.querySelectorAll('.thumb')].forEach((el, idx) => {
      el.classList.toggle('active', idx === tpl.selected);
    });
  }

  function loadDefaultImage(){
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error("No se pudo cargar Cejas.jpg"));
      img.src = "Cejas.jpg";
    });
  }

  function loadFromFile(file){
    return new Promise((resolve, reject) => {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
      img.onerror = () => { URL.revokeObjectURL(url); reject(new Error("No se pudo leer archivo")); };
      img.src = url;
    });
  }

  imgSource.addEventListener('change', async () => {
    uploadRow.style.display = (imgSource.value === 'upload') ? 'flex' : 'none';
    if (imgSource.value === 'default') {
      try {
        tpl.img = await loadDefaultImage();
        rebuildPairs();
        draw();
      } catch (_) {
        alert("No se pudo cargar 'Cejas.jpg'. Usa 'Cargar archivo…' o revisa nombre/ubicación.");
      }
    }
  });

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    try {
      tpl.img = await loadFromFile(file);
      rebuildPairs();
      draw();
    } catch (_) {
      alert("Error al cargar imagen. Prueba JPG/PNG.");
    }
  });

  pairSelect.addEventListener('change', () => {
    tpl.selected = Number(pairSelect.value);
    setActiveThumb();
    draw();
  });

  templateScale.addEventListener('input', draw);
  mirrorOffset.addEventListener('input', draw);
  showGuideSel.addEventListener('change', draw);
  drawLimitSel.addEventListener('change', draw);

  function mirrorX(){ return view.cx + Number(mirrorOffset.value); }

  function drawTemplatePair(){
    const bmp = tpl.pairCanvases[tpl.selected];
    if (!bmp) return null;

    // ancho target según pantalla (responsive)
    const rect = canvas.getBoundingClientRect();
    const maxW = Math.min(980, rect.width * 0.92);
    const scale = Number(templateScale.value)/100;

    const targetW = maxW * scale;
    const ratio = bmp.height / bmp.width;
    const targetH = targetW * ratio;

    ctx.save();
    ctx.translate(view.cx, view.cy);
    ctx.drawImage(bmp, -targetW/2, -targetH/2, targetW, targetH);
    ctx.restore();

    return { targetW, targetH };
  }

  function canDrawHere(pos, tplBox){
    if (drawLimitSel.value !== 'yes') return true;
    if (!tplBox) return true;

    const mx = mirrorX();
    const left = view.cx - tplBox.targetW/2;
    const right = view.cx + tplBox.targetW/2;
    const top = view.cy - tplBox.targetH/2;
    const bottom = view.cy + tplBox.targetH/2;

    if (pos.x < left || pos.x > right || pos.y < top || pos.y > bottom) return false;
    return pos.x <= mx;
  }

  function drawGuide(mx){
    if (showGuideSel.value !== 'yes') return;
    const rect = canvas.getBoundingClientRect();
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.strokeStyle = "#000";
    ctx.setLineDash([6,6]);
    ctx.beginPath();
    ctx.moveTo(mx, 16);
    ctx.lineTo(mx, rect.height - 16);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.restore();
  }

  function drawAllStrokesWithMirror(){
    const mx = mirrorX();
    for (const s of strokes) {
      drawSmoothStroke(s);
      const mirrored = {
        type: s.type,
        size: s.size,
        points: s.points.map(pt => ({ x: (2*mx - pt.x), y: pt.y }))
      };
      drawSmoothStroke(mirrored);
    }
  }

  function draw(){
    const rect = canvas.getBoundingClientRect();

    // fondo
    ctx.clearRect(0,0,rect.width,rect.height);
    ctx.save();
    const g = ctx.createLinearGradient(0,0,0,rect.height);
    g.addColorStop(0,"#ffffff");
    g.addColorStop(1,"#f0f6ff");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,rect.width,rect.height);
    ctx.restore();

    const tplBox = drawTemplatePair();
    const mx = mirrorX();
    drawGuide(mx);
    drawAllStrokesWithMirror();

    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,.55)";
    ctx.font = "14px system-ui, Arial";
    ctx.fillText("Dibuja en la mitad izquierda (se espejea a la derecha).", 14, 22);
    ctx.restore();

    draw._tplBox = tplBox;
  }

  function startDraw(pos){
    const tplBox = draw._tplBox;
    if (!canDrawHere(pos, tplBox)) return;

    drawing = true;
    lastSmoothed = null;

    const s = Number(stabilizerRange.value);
    const p = smoothPoint(lastSmoothed, pos, s);
    lastSmoothed = p;

    current = { type: lineTypeSel.value, size: Number(sizeRange.value), points: [p] };
    strokes.push(current);
    draw();
  }

  function moveDraw(pos){
    if (!drawing || !current) return;

    const tplBox = draw._tplBox;
    if (!canDrawHere(pos, tplBox)) return;

    const s = Number(stabilizerRange.value);
    const p = smoothPoint(lastSmoothed, pos, s);
    lastSmoothed = p;

    const last = current.points[current.points.length - 1];
    const dx = p.x - last.x, dy = p.y - last.y;
    if ((dx*dx + dy*dy) < 1.1) return;

    current.points.push(p);
    draw();
  }

  function endDraw(){
    drawing = false;
    current = null;
    lastSmoothed = null;
  }

  canvas.addEventListener('pointerdown', (ev) => {
    canvas.setPointerCapture(ev.pointerId);
    startDraw(getPointerPos(ev));
  });
  canvas.addEventListener('pointermove', (ev) => moveDraw(getPointerPos(ev)));
  canvas.addEventListener('pointerup', endDraw);
  canvas.addEventListener('pointercancel', endDraw);

  undoBtn.addEventListener('click', () => { strokes.pop(); draw(); });
  clearBtn.addEventListener('click', () => { strokes = []; draw(); });

  window.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') { strokes.pop(); draw(); }
  });

  saveBtn.addEventListener('click', () => {
    // Guardar en resolución real del canvas (device pixels)
    const a = document.createElement('a');
    a.download = 'cejas_espejo.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  });

  // Init
  (async () => {
    try {
      tpl.img = await loadDefaultImage();
      rebuildPairs();
    } catch (_) {
      imgSource.value = 'upload';
      uploadRow.style.display = 'flex';
    }
    // Importante: primero dimensionar canvas
    resizeCanvas();
  })();
})();
</script>

<!-- PWA: registrar SW -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
  }
</script>

</body>
</html>
